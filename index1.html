<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hệ thống Quản Lý Nề Nếp THPT Nguyễn Trãi</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
  
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    .animate-fade-in { animation: fadeIn 0.5s ease-out; }
    .animate-scale-up { animation: scaleUp 0.3s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes scaleUp { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Tùy chỉnh thanh cuộn */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    /* Cursor wait */
    .cursor-wait { cursor: wait; }
  </style>
</head>
<body class="bg-slate-900 text-white">
  
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;
  
    // --- CÁC MÀU NỀN (THEMES) ---
    const THEMES = [
      { id: 'default', name: 'Mặc định (Tối)', class: 'bg-slate-900', iconColor: 'bg-slate-900' },
      { id: 'galaxy', name: 'Galaxy (Xanh Dương)', class: 'bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900', iconColor: 'bg-blue-800' },
      { id: 'dreamy', name: 'Mộng Mơ (Tím)', class: 'bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900', iconColor: 'bg-purple-800' },
      { id: 'power', name: 'Quyền Lực (Đỏ)', class: 'bg-gradient-to-br from-slate-900 via-red-950 to-slate-900', iconColor: 'bg-red-900' },
      { id: 'forest', name: 'Rừng Rậm (Xanh Lá)', class: 'bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900', iconColor: 'bg-emerald-800' },
{ id: 'sunset', name: 'Hoàng Hôn (Cam)', class: 'bg-gradient-to-br from-slate-900 via-orange-900 to-slate-900', iconColor: 'bg-orange-800' },
    ];
  
    // --- XỬ LÝ ICON ---
    const toPascalCase = (str) => str.replace(/(^\w|-\w)/g, (clear) => clear.replace('-', '').toUpperCase());
    const Icon = ({ name, size = 24, className, ...props }) => {
      const ref = useRef(null);
      useEffect(() => {
        if (window.lucide && window.lucide.icons && ref.current) {
          const iconName = toPascalCase(name);
          const iconNode = window.lucide.icons[iconName];
          if (iconNode) {
            ref.current.innerHTML = '';
            const svg = window.lucide.createElement(iconNode);
            svg.setAttribute('width', size);
            svg.setAttribute('height', size);
            if (className) svg.setAttribute('class', className);
            Object.keys(props).forEach(key => {
              const attrName = key.replace(/([A-Z])/g, "-$1").toLowerCase();
              svg.setAttribute(attrName, props[key]);
            });
            ref.current.appendChild(svg);
          }
        }
      }, [name, size, className, props]); 
      return <span ref={ref} style={{ display: 'inline-flex', verticalAlign: 'middle' }}></span>;
    };
  
    // --- CẤU HÌNH ---
    const USE_MOCK_DATA = false; 
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbysZWLq8FCjIrxJ0n5vJgLsoX5SRdk4hA1kU5ZNli28hrKlizGo5Q9OBTc_cfEX4dN5pw/exec';
    const LOGO_URL = "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQ9tx42ri-D4HFIbkykt6qkhjnJYkFfr0Msng&s";
  
    const CLASS_LIST = [
      ...Array.from({ length: 9 }, (_, i) => `10/${i + 1}`),
      ...Array.from({ length: 10 }, (_, i) => `11/${i + 1}`),
      ...Array.from({ length: 10 }, (_, i) => `12/${i + 1}`)
    ];

    // --- CẤU HÌNH KHỐI (NEW) ---
    const GRADES = ['10', '11', '12'];
  
    // --- HÀM XỬ LÝ LỚP ---
    const formatClassForSheet = (className) => `'${className}`; 
    const formatClassFromSheet = (val) => {
      if (!val) return '';
      const str = String(val);
      if (str.startsWith("'")) return str.replace(/^'/, '');
      if (str.match(/^\d{4}-\d{2}-\d{2}/)) {
        const d = new Date(str);
        if (isNaN(d.getTime())) return str;
        const day = d.getDate();
        const month = d.getMonth() + 1;
        const case1 = `${day}/${month}`; 
        const case2 = `${month}/${day}`; 
        if (CLASS_LIST.includes(case2)) return case2; 
        if (CLASS_LIST.includes(case1)) return case1;
        return case2; 
      }
      return str;
    };
  
    // --- HÀM XỬ LÝ TÊN ---
    const getFullName = (user) => {
      if (!user) return '';
      if (user.firstName && user.lastName) {
return `${user.firstName} ${user.lastName}`;
      }
      return user.fullName || user.username || 'Người dùng';
    };
  
    // --- HÀM HIỂN THỊ ROLE ---
    const getRoleDisplayName = (role) => {
      if (role === 'admin') return 'Admin';
      if (role === 'teacher') return 'Giáo viên';
      if (role === 'prefect') return 'Ban Thi Đua';
      return role;
    };
  
    const MOCK_DB = { users: [], students: [], violations: [] };
  
    const api = {
      fetchData: async (action) => {
        if (USE_MOCK_DATA) return new Promise(resolve => setTimeout(() => resolve(MOCK_DB[action] || []), 500));
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); 
        try {
          const res = await fetch(`${APPS_SCRIPT_URL}?action=${action}&t=${Date.now()}`, { signal: controller.signal });
          clearTimeout(timeoutId);
          const rawData = await res.json();
          return Array.isArray(rawData) ? rawData.map(item => ({ ...item, classId: item.classId ? formatClassFromSheet(item.classId) : item.classId })) : [];
        } catch (error) { console.error("API Error:", error); return []; }
      },
      postData: async (action, data) => {
        const dataToSend = { ...data };
        if (dataToSend.classId) dataToSend.classId = formatClassForSheet(dataToSend.classId);
        
        if (USE_MOCK_DATA) {
          if(action === 'addStudent') MOCK_DB.students.push({...data, id: Date.now()}); 
          if(action === 'addViolation') MOCK_DB.violations.push({...data, id: Date.now()});
          if(action === 'deleteViolation') MOCK_DB.violations = MOCK_DB.violations.filter(v => v.id !== data.id);
          if(action === 'deleteStudent') MOCK_DB.students = MOCK_DB.students.filter(s => s.id !== data.id);
          return { success: true };
        }
        try {
          await fetch(APPS_SCRIPT_URL, { 
            method: 'POST', 
            mode: 'no-cors', 
            headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
            body: JSON.stringify({ action, ...dataToSend }) 
          });
          return { success: true };
        } catch (error) { return { success: false }; }
      }
    };
  
    // --- HELPER COMPONENTS ---
    const Toast = ({ message, type, onClose }) => {
      useEffect(() => { const timer = setTimeout(onClose, 3000); return () => clearTimeout(timer); }, [onClose]);
      if (!message) return null;
      return (
        <div className={`fixed top-4 right-4 px-6 py-3 rounded-lg shadow-xl z-[70] flex items-center gap-2 text-white font-bold animate-bounce ${type === 'error' ? 'bg-red-600' : 'bg-green-600'}`}>
<Icon name={type === 'error' ? 'alert-triangle' : 'check-circle'} size={20}/> {message}
        </div>
      );
    };

    // Component Nút chọn khối (Giao diện Tabs) - NEW
    const GradeTabs = ({ current, onChange }) => (
      <div className="flex bg-slate-900 p-1 rounded-lg border border-slate-700 w-fit mb-2 md:mb-0">
        <button 
          onClick={() => onChange('')} 
          className={`px-3 py-1.5 rounded-md text-sm font-bold transition-all ${current === '' ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
        >
          Tất cả
        </button>
        {GRADES.map(g => (
          <button 
            key={g} 
            onClick={() => onChange(g)} 
            className={`px-3 py-1.5 rounded-md text-sm font-bold transition-all ${current === g ? 'bg-blue-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-slate-800'}`}
          >
            K{g}
          </button>
        ))}
      </div>
    );
  
    // --- THEME SELECTOR ---
    const ThemeSelector = ({ currentTheme, onSelectTheme }) => {
      const [isOpen, setIsOpen] = useState(false);
      const wrapperRef = useRef(null);
      useEffect(() => {
        function handleClickOutside(event) { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) { setIsOpen(false); } }
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
      }, [wrapperRef]);
      
      return (
        <div className="relative" ref={wrapperRef}>
          <button onClick={() => setIsOpen(!isOpen)} className="p-2 rounded-full hover:bg-white/10 transition-colors text-white border border-white/20 shadow-sm flex items-center justify-center bg-slate-800/50 backdrop-blur-sm" title="Đổi giao diện">
            <Icon name="palette" size={20} />
          </button>
          {isOpen && (
            <div className="absolute right-0 top-full mt-3 w-56 bg-slate-800 border border-slate-600 rounded-xl shadow-2xl p-2 z-50 animate-fade-in overflow-hidden">
              <h4 className="text-xs font-bold text-slate-400 px-3 py-2 uppercase tracking-wider border-b border-slate-700 mb-1">Chọn màu nền</h4>
              {THEMES.map(t => (
                <button key={t.id} onClick={() => { onSelectTheme(t); setIsOpen(false); }} className={`w-full text-left px-3 py-2.5 rounded-lg text-sm flex items-center gap-3 hover:bg-slate-700 transition-all mb-1 ${currentTheme.id === t.id ? 'bg-slate-700 ring-1 ring-blue-500' : ''}`}>
                  <div className={`w-5 h-5 rounded-full ${t.iconColor} border border-slate-500 shadow-inner`}></div>
<span className={currentTheme.id === t.id ? 'text-white font-bold' : 'text-slate-300'}>{t.name}</span>
                  {currentTheme.id === t.id && <Icon name="check" size={14} className="ml-auto text-blue-400"/>}
                </button>
              ))}
            </div>
          )}
        </div>
      );
    };
  
    // --- LOGO COMPONENT ---
    const SchoolLogo = ({ size = "md", className }) => {
      const dim = size === "lg" ? "w-24 h-24" : "w-12 h-12";
      return (
        <a href="http://thptnguyentraidana.edu.vn/" target="_blank" rel="noopener noreferrer" className={`block rounded-full overflow-hidden shadow-lg hover:scale-105 transition-transform ${className}`} title="Truy cập Website Trường THPT Nguyễn Trãi">
          <div className={`${dim} bg-white flex items-center justify-center border-2 border-red-500 overflow-hidden`}>
            <img src={LOGO_URL} alt="Logo THPT Nguyễn Trãi" className="w-full h-full object-cover" />
          </div>
        </a>
      );
    };
  
    // --- CHART COMPONENT ---
    const BarChart = ({ data }) => {
      const chartRef = useRef(null);
      const canvasRef = useRef(null);
      useEffect(() => {
        if (!canvasRef.current || !window.Chart) return;
        const ctx = canvasRef.current.getContext('2d');
        if (chartRef.current) chartRef.current.destroy();
        chartRef.current = new Chart(ctx, {
          type: 'bar',
          data: { labels: data.map(d => d.name), datasets: [{ label: 'Số lần vi phạm', data: data.map(d => d.count), backgroundColor: 'rgba(59, 130, 246, 0.8)', borderColor: 'rgba(59, 130, 246, 1)', borderWidth: 1, borderRadius: 4 }] },
          options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: '#94a3b8', stepSize: 1 }, grid: { color: '#334155' } }, x: { ticks: { color: '#94a3b8' }, grid: { display: false } } } }
        });
        return () => { if (chartRef.current) chartRef.current.destroy(); };
      }, [data]);
      return <canvas ref={canvasRef} />;
    };
  
    // --- REUSABLE COMPONENTS ---
    const PasswordField = ({ value, onChange, placeholder = "Mật khẩu" }) => {
      const [show, setShow] = useState(false);
      return (
        <div className="flex items-center bg-slate-900 rounded-xl border border-slate-600 px-4 py-3 focus-within:border-blue-500 transition-all">
          <Icon name="lock" size={20} className="text-slate-500 mr-3"/>
          <input value={value} onChange={onChange} type={show ? "text" : "password"} className="bg-transparent flex-1 text-white outline-none" placeholder={placeholder} />
<button type="button" onClick={() => setShow(!show)} className="text-slate-500 hover:text-white transition-colors focus:outline-none"><Icon name={show ? "eye-off" : "eye"} size={20}/></button>
        </div>
      );
    };

    const ApproveComponent = ({ usersList, setUsersList, showToast }) => {
      const pending = usersList.filter(u => u.status === 'pending');
      const handleAction = (uid) => {
        setUsersList(prev => prev.map(u => u.id === uid ? { ...u, status: 'approved' } : u));
        api.postData('approveUser', { id: uid }); 
        showToast('Đã duyệt');
      };
      return (
        <div className="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg animate-fade-in">
          <h3 className="text-xl font-bold mb-4 text-orange-400 flex items-center gap-2"><Icon name="check-circle"/> Phê duyệt tài khoản</h3>
          <div className="overflow-x-auto">
            <table className="w-full text-left text-sm border-collapse">
              <thead className="bg-slate-700 text-slate-300"><tr><th className="p-4">Họ tên</th><th className="p-4">Email</th><th className="p-4">Chức vụ</th><th className="p-4">Thao tác</th></tr></thead>
              <tbody className="divide-y divide-slate-700">
                {pending.length === 0 ? <tr><td colSpan="4" className="p-8 text-center text-slate-500 italic">Không có yêu cầu nào.</td></tr> : 
                pending.map(u => (<tr key={u.id} className="hover:bg-slate-700/50"><td className="p-4">{getFullName(u)}</td><td className="p-4">{u.email}</td><td className="p-4">{getRoleDisplayName(u.role)}</td><td className="p-4"><button onClick={()=>handleAction(u.id)} className="bg-green-600 px-3 py-1 rounded text-xs font-bold">DUYỆT</button></td></tr>))}
              </tbody>
            </table>
          </div>
        </div>
      );
    };
  
    const ManageComponent = ({ usersList, showToast }) => {
      const [tab, setTab] = useState('teacher');
      const [localTeachers, setLocalTeachers] = useState([]);
      const [studentsList, setStudentsList] = useState([]);
      const [newStu, setNewStu] = useState({ name: '', classId: '10/1' });
      const [isSubmitting, setIsSubmitting] = useState(false);
      const [deletingStuId, setDeletingStuId] = useState(null);
      const [studentSearch, setStudentSearch] = useState('');
      
      // MỚI: State lưu khối đang chọn
      const [filterGrade, setFilterGrade] = useState(''); 
  
      useEffect(() => {
        const validTeachers = usersList.filter(u => u.role === 'teacher' && u.status === 'approved').map(u => ({ ...u, fullName: getFullName(u) }));
        setLocalTeachers(validTeachers);
      }, [usersList]);
      
useEffect(() => { api.fetchData('students').then(data => { if (data.length > 0) setStudentsList(data); }); }, []);
  
      const updateClass = async (uid, cls) => {
        setLocalTeachers(prev => prev.map(t => t.id === uid ? { ...t, classId: cls } : t));
        await api.postData('updateTeacherClass', { id: uid, classId: cls });
        showToast('Đã cập nhật lớp');
      };
  
      const addStudent = async () => {
        if (isSubmitting) return;
        if (!newStu.name) return showToast('Nhập tên HS', 'error');
        setIsSubmitting(true);
        const studentId = Date.now();
        try {
          setStudentsList(prev => [...prev, { id: studentId, fullName: newStu.name, classId: newStu.classId }]);
          await api.postData('addStudent', { id: studentId, fullName: newStu.name, classId: newStu.classId });
          showToast('Đã thêm HS'); setNewStu({ ...newStu, name: '' });
        } catch (error) { showToast('Lỗi khi thêm học sinh', 'error'); }
        finally { setIsSubmitting(false); }
      };
  
      const deleteStudent = async (id) => {
        if (!window.confirm('Bạn chắc chắn muốn xóa học sinh này?')) return;
        setDeletingStuId(id);
        try {
          await api.postData('deleteStudent', { id });
          setStudentsList(prev => prev.filter(s => s.id !== id));
          showToast('Đã xóa học sinh');
        } catch (error) { showToast('Lỗi khi xóa học sinh', 'error'); }
        finally { setDeletingStuId(null); }
      }
  
      // MỚI: Cập nhật logic lọc (Tìm kiếm + Khối)
      const filteredStudentsList = useMemo(() => {
        let result = studentsList;
        // 1. Lọc theo khối
        if (filterGrade) {
          result = result.filter(s => s.classId && s.classId.startsWith(filterGrade));
        }
        // 2. Lọc theo từ khóa tìm kiếm
        if (studentSearch) {
          const lowerSearch = studentSearch.toLowerCase();
          result = result.filter(s =>
            (s.fullName && s.fullName.toLowerCase().includes(lowerSearch)) ||
            (s.classId && s.classId.toLowerCase().includes(lowerSearch))
          );
        }
        return result;
      }, [studentsList, studentSearch, filterGrade]);
  
      return (
        <div className="space-y-6 animate-fade-in">
          <div className="flex gap-4 border-b border-slate-700 pb-4"><button onClick={() => setTab('teacher')} className={`px-6 py-2 rounded-full font-bold ${tab === 'teacher' ? 'bg-blue-600' : 'bg-slate-700'}`}>Giáo viên CN</button><button onClick={() => setTab('student')} className={`px-6 py-2 rounded-full font-bold ${tab === 'student' ? 'bg-blue-600' : 'bg-slate-700'}`}>Học sinh</button></div>
          {tab === 'teacher' ? (
<div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              {localTeachers.length === 0 ? <div className="col-span-3 text-center p-8 text-slate-500 border border-dashed rounded-xl">Chưa có dữ liệu GV.</div> :
                localTeachers.map(t => (<div key={t.id} className="bg-slate-800 p-6 rounded-xl border border-slate-700 flex flex-col gap-3 shadow-lg"><div className="flex items-center gap-3 pb-3 border-b border-slate-700"><div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-lg">{(t.fullName || '?').charAt(0)}</div><div><div className="font-bold">{t.fullName}</div><div className="text-xs text-slate-400">{t.email}</div></div></div><div><label className="text-xs uppercase font-bold mb-1 block">Lớp chủ nhiệm:</label><select className="w-full bg-slate-900 border border-slate-600 rounded p-2 outline-none" value={t.classId || ''} onChange={(e) => updateClass(t.id, e.target.value)}><option value="">-- Chọn --</option>{CLASS_LIST.map(c => <option key={c} value={c}>{c}</option>)}</select></div></div>))
              }
            </div>
          ) : (
            <div className="flex flex-col items-center">
              <div className="bg-slate-900 p-6 rounded-3xl border border-slate-800 shadow-xl w-full max-w-md relative z-10 overflow-hidden mb-8">
                  {isSubmitting && (<div className="absolute inset-0 bg-slate-900/80 z-50 flex flex-col items-center justify-center backdrop-blur-sm animate-fade-in"><div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-2"></div><div className="text-blue-400 font-bold text-sm">Đang cập nhật...</div></div>)}
                  <h3 className="text-center text-xl font-bold mb-4 text-blue-300">Thêm học sinh mới</h3>
                  <div className="space-y-4">
                    <div><label className="block text-slate-400 mb-2 font-bold text-sm pl-1">Lớp</label><select className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-600" value={newStu.classId} onChange={e=>setNewStu({...newStu, classId: e.target.value})}>{CLASS_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                    <div><label className="block text-slate-400 mb-2 font-bold text-sm pl-1">Tên học sinh</label><input className="w-full bg-slate-800 border border-slate-700 text-white p-3 rounded-xl outline-none focus:ring-2 focus:ring-blue-600" placeholder="Nhập tên học sinh..." value={newStu.name} onChange={e=>setNewStu({...newStu, name: e.target.value})}/></div>
<div className="pt-2"><button onClick={addStudent} disabled={isSubmitting} className="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2">{isSubmitting ? <Icon name="loader" className="animate-spin" size={20}/> : "Thêm vào danh sách"}</button></div>
                  </div>
              </div>
              
              <div className="w-full max-w-4xl">
                <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                  <div className="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h4 className="font-bold text-slate-300 uppercase text-sm tracking-widest">Danh sách ({filteredStudentsList.length})</h4>
                    
                    {/* MỚI: UI Lọc và Tìm kiếm */}
                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto items-center">
                        <GradeTabs current={filterGrade} onChange={setFilterGrade} />
                        <div className="relative w-full sm:w-64">
                            <input type="text" className="w-full bg-slate-900 border border-slate-600 rounded-lg py-1.5 pl-9 pr-4 text-sm focus:border-blue-500 outline-none transition-colors" placeholder="Tìm tên hoặc lớp..." value={studentSearch} onChange={(e) => setStudentSearch(e.target.value)} />
                            <div className="absolute left-3 top-2 text-slate-500"><Icon name="search" size={16}/></div>
                        </div>
                    </div>
                  </div>
    
                  <div className="max-h-[400px] overflow-y-auto space-y-2 pr-2 custom-scrollbar">
                    {filteredStudentsList.length === 0 ? <div className="text-center text-slate-500 text-sm py-8">Chưa có dữ liệu phù hợp.</div> : filteredStudentsList.map((s, idx) => (
                      <div key={idx} className="flex justify-between items-center p-3 bg-slate-900/50 rounded-lg border border-slate-700/50 hover:border-blue-500/50 group">
                        <div className="flex items-center gap-3">
                             <span className={`w-8 h-8 rounded flex items-center justify-center text-xs font-bold ${s.classId.startsWith('12') ? 'bg-red-900/30 text-red-400' : s.classId.startsWith('11') ? 'bg-yellow-900/30 text-yellow-400' : 'bg-blue-900/30 text-blue-400'}`}>{s.classId}</span>
                             <span className="font-medium text-slate-200">{s.fullName}</span>
                        </div>
<button onClick={() => deleteStudent(s.id)} disabled={deletingStuId === s.id} className="text-slate-600 group-hover:text-red-400 p-2 rounded hover:bg-red-900/20 transition-all">
                          {deletingStuId === s.id ? <Icon name="loader" className="animate-spin" size={16} /> : <Icon name="trash-2" size={16} />}
                        </button>
                      </div>
                    ))}</div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const ReportComponent = ({ studentsList, appUser, showToast }) => {
      const [form, setForm] = useState({ date: new Date().toISOString().split('T')[0], studentId: '', violation: '' });
      const [search, setSearch] = useState('');
      const [debouncedSearch, setDebouncedSearch] = useState('');
      const [showPreview, setShowPreview] = useState(false);
      const [isSubmitting, setIsSubmitting] = useState(false);
      
      useEffect(() => { const handler = setTimeout(() => { setDebouncedSearch(search); }, 100); return () => { clearTimeout(handler); }; }, [search]);
      const filteredStudents = debouncedSearch ? studentsList.filter(s => s.fullName.toLowerCase().includes(debouncedSearch.toLowerCase())).slice(0,5) : [];
      const getStudentDetails = () => studentsList.find(s => s.id === form.studentId) || {};
      
      const handlePreview = () => { if(!form.studentId || !form.violation) return showToast('Vui lòng điền đủ thông tin!', 'error'); setShowPreview(true); };
      const submitReport = async () => {
        if (isSubmitting) return;
        const stu = getStudentDetails();
        if (!stu.id) return showToast('Học sinh không hợp lệ', 'error');
        setIsSubmitting(true);
        try {
          setShowPreview(false);
          await api.postData('addViolation', { date: form.date, studentId: stu.id, studentName: stu.fullName, classId: stu.classId, content: form.violation, reporter: getFullName(appUser), reporterRole: appUser.role });
          showToast('Đã gửi báo cáo & Email cho GVCN!'); setForm({...form, violation: '', studentId: ''}); setSearch('');
        } catch (error) { showToast('Có lỗi xảy ra khi gửi báo cáo!', 'error'); } 
        finally { setIsSubmitting(false); }
      };
      
      const PreviewModal = () => {
        const stu = getStudentDetails();
        return (
          <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
            <div className="bg-slate-800 rounded-2xl w-full max-w-lg border border-slate-600 shadow-2xl animate-scale-up overflow-hidden flex flex-col max-h-[90vh]">
<div className="bg-slate-900 p-4 border-b border-slate-700 flex justify-between items-center">
                <h3 className="text-lg font-bold text-white flex items-center gap-2"><Icon name="eye" size={20} className="text-blue-400"/> Xem trước báo cáo</h3>
                <button onClick={() => !isSubmitting && setShowPreview(false)} disabled={isSubmitting} className="text-slate-400 hover:text-white disabled:opacity-50"><Icon name="x"/></button>
              </div>
              <div className="p-6 space-y-4 overflow-y-auto custom-scrollbar">
                <div className="bg-slate-900/50 p-4 rounded-xl border border-slate-700 space-y-2"><div className="flex justify-between"><span className="text-slate-400 text-sm">Ngày báo cáo:</span><span className="font-mono font-bold">{form.date}</span></div><div className="flex justify-between"><span className="text-slate-400 text-sm">Người báo cáo:</span><span className="font-bold text-blue-300">{getFullName(appUser)}</span></div></div>
                <div className="space-y-1"><label className="text-xs uppercase font-bold text-slate-500">Thông tin học sinh</label><div className="flex items-center gap-3 bg-slate-700/30 p-3 rounded-lg border border-slate-600"><div className="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center font-bold text-lg">{stu.fullName?.charAt(0)}</div><div><div className="font-bold text-lg">{stu.fullName}</div><div className="text-sm text-slate-400">Lớp: <span className="text-white font-bold">{stu.classId}</span></div></div></div></div>
                <div className="space-y-1"><label className="text-xs uppercase font-bold text-slate-500">Nội dung vi phạm</label><div className="bg-red-900/10 border border-red-500/30 p-4 rounded-lg text-red-200 leading-relaxed">{form.violation}</div></div>
              </div>
              <div className="p-4 bg-slate-900 border-t border-slate-700 flex gap-3">
                <button onClick={() => setShowPreview(false)} disabled={isSubmitting} className="flex-1 py-3 rounded-lg font-bold text-slate-300 hover:bg-slate-800 transition-colors disabled:opacity-50">Chỉnh sửa</button>
                <button onClick={submitReport} disabled={isSubmitting} className="flex-1 bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold text-white shadow-lg shadow-blue-600/20 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">{isSubmitting ? <Icon name="loader" className="animate-spin" size={18}/> : <Icon name="send" size={18}/>} {isSubmitting ? 'Đang gửi...' : 'Xác nhận gửi'}</button>
              </div>
            </div>
          </div>
        );
      };
      return (
        <>
<div className="bg-slate-800 p-8 rounded-2xl border border-slate-700 max-w-2xl mx-auto shadow-xl animate-fade-in relative">
            {isSubmitting && (<div className="absolute inset-0 bg-slate-900/80 z-50 rounded-2xl flex flex-col items-center justify-center backdrop-blur-sm animate-fade-in"><div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4"></div><div className="text-white font-bold text-lg">Đang gửi báo cáo...</div><div className="text-slate-400 text-sm mt-2">Vui lòng không tắt trình duyệt</div></div>)}
            <h2 className="text-2xl font-bold mb-6 text-center uppercase text-red-500 flex justify-center gap-2"><Icon name="alert-triangle" size={28}/> Báo cáo vi phạm</h2>
            <div className="space-y-5">
              <div><label className="block text-slate-400 mb-2 text-sm">Ngày</label><input type="date" className="w-full bg-slate-900 border border-slate-600 p-3 rounded text-white" value={form.date} onChange={e=>setForm({...form, date: e.target.value})}/></div>
              <div className="relative">
                <label className="block text-slate-400 mb-2 text-sm">Học sinh</label>
                <input type="text" className="w-full bg-slate-900 border border-slate-600 p-3 rounded pl-10" placeholder="Nhập tên..." value={search} onChange={e=>setSearch(e.target.value)}/>
                <div className="absolute left-3 top-10 text-slate-500"><Icon name="search" size={18}/></div>
                {filteredStudents.length > 0 && (<div className="absolute top-full w-full bg-slate-700 shadow-xl z-10 rounded mt-1 border border-slate-600">{filteredStudents.map(s=>(<div key={s.id} className="p-3 hover:bg-slate-600 cursor-pointer flex justify-between" onClick={()=>{setForm({...form, studentId: s.id}); setSearch(`${s.fullName} - ${s.classId}`); }}><span>{s.fullName}</span><span className="text-xs bg-slate-800 px-2 py-1 rounded">{s.classId}</span></div>))}</div>)}
              </div>
              <div><label className="block text-slate-400 mb-2 text-sm">Lỗi vi phạm</label><textarea className="w-full bg-slate-900 border border-slate-600 p-3 rounded h-32 text-white" value={form.violation} onChange={e=>setForm({...form, violation: e.target.value})} placeholder="Mô tả lỗi..."/></div>
              <div className="grid grid-cols-2 gap-4">
                <button onClick={handlePreview} disabled={isSubmitting} className="bg-slate-700 hover:bg-slate-600 p-4 rounded font-bold text-white shadow-lg flex items-center justify-center gap-2 disabled:opacity-50"><Icon name="eye" size={20}/> XEM TRƯỚC</button>
<button onClick={submitReport} disabled={isSubmitting} className="bg-red-600 hover:bg-red-700 p-4 rounded font-bold text-white shadow-lg flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed">{isSubmitting ? <Icon name="loader" className="animate-spin" size={20}/> : <Icon name="send" size={20}/>} {isSubmitting ? 'Đang gửi...' : 'GỬI LUÔN'}</button>
              </div>
            </div>
          </div>
          {showPreview && <PreviewModal />}
        </>
      );
    };
  
    const StatsComponent = ({ violationsList, showToast, appUser, refreshData, onDeleteLocal }) => {
        const currentYear = new Date().getFullYear();
        const [year, setYear] = useState(currentYear);
        const [month, setMonth] = useState(new Date().getMonth() + 1);
        const [day, setDay] = useState(''); 
        const [viewMode, setViewMode] = useState('list'); 
        const [filterClass, setFilterClass] = useState('');
        const [filterGrade, setFilterGrade] = useState(''); // MỚI: State lọc khối
        const [deletingId, setDeletingId] = useState(null);
        
        // Logic lọc dữ liệu
        const filtered = violationsList.filter(v => { 
            const d = new Date(v.date); 
            const matchYear = d.getFullYear() === parseInt(year);
            const matchMonth = (d.getMonth() + 1) === parseInt(month);
            const matchDay = day ? d.getDate() === parseInt(day) : true;
            const matchClass = filterClass ? v.classId === filterClass : true;
            
            // MỚI: Lọc theo khối
            const matchGrade = filterGrade ? v.classId.startsWith(filterGrade) : true;
            
            return matchYear && matchMonth && matchDay && matchClass && matchGrade;
        }).sort((a,b) => new Date(b.date) - new Date(a.date));
        
        // Logic hiển thị biểu đồ (Chỉ hiển thị các lớp thuộc khối đang chọn nếu có)
        const chartData = useMemo(() => {
            const relevantClasses = filterGrade ? CLASS_LIST.filter(c => c.startsWith(filterGrade)) : CLASS_LIST;
            const map = {}; 
            relevantClasses.forEach(c => map[c] = 0); 
            filtered.forEach(v => { if(map[v.classId]!==undefined) map[v.classId]++ });
            return Object.keys(map).map(k => ({ name: k, count: map[k] }));
        }, [filtered, filterGrade]);
        
        const handleDelete = async (id, violation) => {
            if (!window.confirm('Bạn có chắc chắn muốn xóa vi phạm này không?')) return;
            const isAdmin = appUser.role === 'admin';
            const isTeacher = appUser.role === 'teacher';
            const isPrefect = appUser.role === 'prefect';
const isViolationByTeacher = violation.reporterRole === 'teacher';
            const isViolationByPrefect = violation.reporterRole === 'prefect';
            
            if (isAdmin) { /* OK */ }
            else if (isTeacher && isViolationByTeacher) { /* OK */ }
            else if (isPrefect && isViolationByPrefect) { /* OK */ }
            else { showToast('Bạn không có quyền xóa báo cáo của chức vụ khác!', 'error'); return; }
            
            setDeletingId(id);
            try {
            await api.postData('deleteViolation', { id });
            showToast('Đã xóa vi phạm');
            if (onDeleteLocal) onDeleteLocal(id); 
            refreshData(true); 
            } catch (error) { showToast('Lỗi khi xóa', 'error'); } 
            finally { setDeletingId(null); }
        };
        
        return (
            <div className="space-y-6 animate-fade-in">
            <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                <div className="flex flex-col md:flex-row justify-between items-center gap-4 mb-4 border-b border-slate-700 pb-4">
                    <h3 className="font-bold text-lg flex items-center gap-2 mr-2"><Icon name="bar-chart-2" size={24}/> Thống kê vi phạm</h3>
                    {/* MỚI: Thêm tabs chọn khối */}
                    <GradeTabs current={filterGrade} onChange={(val) => { setFilterGrade(val); setFilterClass(''); }} />
                </div>
    
                <div className="flex flex-wrap items-center justify-between gap-4">
                    <div className="flex flex-wrap gap-2">
                        <select value={year} onChange={e=>setYear(e.target.value)} className="bg-slate-900 border border-slate-600 p-2 rounded-lg text-sm text-white outline-none focus:border-blue-500">{Array.from({length: 5}, (_, i) => currentYear - 2 + i).map(y => (<option key={y} value={y}>Năm {y}</option>))}</select>
                        <select value={month} onChange={e=>setMonth(e.target.value)} className="bg-slate-900 border border-slate-600 p-2 rounded-lg text-sm text-white outline-none focus:border-blue-500">{Array.from({length:12},(_,i)=>i+1).map(m=><option key={m} value={m}>Tháng {m}</option>)}</select>
                        <select value={day} onChange={e=>setDay(e.target.value)} className="bg-slate-900 border border-slate-600 p-2 rounded-lg text-sm text-white outline-none focus:border-blue-500"><option value="">Cả tháng</option>{Array.from({length:31},(_,i)=>i+1).map(d=><option key={d} value={d}>Ngày {d}</option>)}</select>
                        
                        {/* Dropdown Lớp: Chỉ hiện các lớp thuộc khối đã chọn (nếu có) */}
<select value={filterClass} onChange={e=>setFilterClass(e.target.value)} className="bg-slate-900 border border-slate-600 p-2 rounded-lg text-sm text-white outline-none focus:border-blue-500">
                            <option value="">-- Tất cả lớp --</option>
                            {CLASS_LIST.filter(c => !filterGrade || c.startsWith(filterGrade)).map(c=><option key={c} value={c}>{c}</option>)}
                        </select>
                    </div>
                    <div className="flex gap-2 w-full lg:w-auto justify-end">
                        <button onClick={()=>setViewMode('list')} className={`px-4 py-2 rounded text-sm font-bold ${viewMode==='list'?'bg-blue-600':'bg-slate-700 hover:bg-slate-600'}`}>Thẻ</button>
                        <button onClick={()=>setViewMode('chart')} className={`px-4 py-2 rounded text-sm font-bold ${viewMode==='chart'?'bg-blue-600':'bg-slate-700 hover:bg-slate-600'}`}>Biểu đồ</button>
                    </div>
                </div>
            </div>
    
            {viewMode === 'chart' && (<div className="bg-slate-800 p-6 rounded-xl border border-slate-700 h-[400px] relative"><BarChart data={chartData} /></div>)}
            {viewMode === 'list' && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {filtered.length === 0 ? <div className="col-span-full text-center p-8 text-slate-500 italic">Không có vi phạm nào trong {day ? `ngày ${day}` : ''} tháng {month}/{year}.</div> : 
                    filtered.map((v, idx) => (
                    <div key={idx} className="bg-slate-800 rounded-xl border border-slate-700 p-5 shadow-md hover:border-red-500/50 transition-colors group relative overflow-hidden">
                        <div className="absolute left-0 top-0 bottom-0 w-1.5 bg-red-600"></div>
                        <button onClick={(e) => { e.stopPropagation(); handleDelete(v.id, v); }} disabled={deletingId === v.id} className="absolute top-2 right-2 p-2 bg-red-600 text-white rounded-full shadow-md hover:bg-red-700 transition-all z-10" title="Xóa vi phạm">
                        {deletingId === v.id ? <Icon name="loader" className="animate-spin" size={16}/> : <Icon name="trash-2" size={16}/>}
                        </button>
                        <div className="pl-3 pr-8">
<div className="flex justify-between items-center mb-3"><div className="flex items-center gap-2 text-slate-400 text-xs font-mono bg-slate-900/50 px-2 py-1 rounded"><Icon name="calendar" size={12}/> {v.date}</div><span className="bg-orange-500/20 text-orange-400 px-3 py-1 rounded-full text-xs font-bold font-mono border border-orange-500/30">{v.classId}</span></div>
                        <h4 className="text-lg font-bold text-white mb-2 truncate" title={v.studentName}>{v.studentName}</h4>
                        <div className="bg-red-900/10 border border-red-900/30 p-3 rounded-lg mb-3"><p className="text-red-300 text-sm leading-relaxed line-clamp-2" title={v.content}>{v.content}</p></div>
                        <div className="flex items-center justify-between pt-2 border-t border-slate-700/50 text-xs text-slate-500"><span className="flex items-center gap-1"><Icon name="user-check" size={14}/> {v.reporter}</span><span className={`px-2 py-0.5 rounded ${v.reporterRole==='admin'?'bg-purple-900/30 text-purple-400':'bg-blue-900/30 text-blue-400'}`}>{getRoleDisplayName(v.reporterRole)}</span></div>
                        </div>
                    </div>
                    ))
                }
                </div>
            )}
            </div>
        );
    };
  
    const RankingComponent = ({ showToast, api, CLASS_LIST }) => {
        const [week, setWeek] = useState(1);
        const [isEditing, setIsEditing] = useState(false);
        const [isLoading, setIsLoading] = useState(false);
        const [inputData, setInputData] = useState({});
        const [filterGrade, setFilterGrade] = useState(''); // MỚI
    
        useEffect(() => { loadScores(); }, [week]);
    
        const loadScores = async () => {
            setIsLoading(true);
            const allScores = await api.fetchData('getScores');
            const weeklyScores = Array.isArray(allScores) ? allScores.filter(s => s.week == week) : [];
            
            const initialData = {};
            CLASS_LIST.forEach(cls => {
                const found = weeklyScores.find(s => s.classId == cls);
                initialData[cls] = found ? { a: found.scoreA, b: found.scoreB, c: found.scoreC, d: found.scoreD } : { a: '', b: 100, c: 100, d: 0 }; 
            });
            setInputData(initialData);
            setIsLoading(false);
        };
    
        const calculateTotal = (a, b, c, d) => {
            const A = parseFloat(a) || 0; const B = parseFloat(b) || 0; const C = parseFloat(c) || 0; const D = parseFloat(d) || 0;
            const T = ((3 * A + 2 * B + C) / 6) + D;
            return parseFloat(T.toFixed(2));
        };
    
const handleInputChange = (cls, field, value) => { 
            setInputData(prev => ({ ...prev, [cls]: { ...prev[cls], [field]: value } })); 
        };
    
        const saveAllScores = async () => {
            setIsLoading(true);
            const promises = CLASS_LIST.map(cls => {
                const d = inputData[cls];
                if (d.a !== '' && d.a !== null) {
                    const total = calculateTotal(d.a, d.b, d.c, d.d);
                    return api.postData('saveScores', { week: week, classId: cls, scoreA: d.a, scoreB: d.b, scoreC: d.c, scoreD: d.d, total: total });
                }
                return Promise.resolve(null);
            });
            await Promise.all(promises);
            showToast(`Đã lưu điểm Tuần ${week}`); setIsEditing(false); loadScores();
        };
    
        // MỚI: Lọc danh sách hiển thị theo Khối
        const displayList = useMemo(() => {
            let list = CLASS_LIST;
            if (filterGrade) {
                list = list.filter(cls => cls.startsWith(filterGrade));
            }
            return list;
        }, [CLASS_LIST, filterGrade]);
    
        const sortedRanking = useMemo(() => {
            return displayList.map(cls => {
                const d = inputData[cls] || { a: 0, b: 100, c: 100, d: 0 };
                if (d.a === '' || d.a === undefined) return null;
                return { classId: cls, ...d, total: calculateTotal(d.a, d.b, d.c, d.d) };
            }).filter(item => item !== null).sort((x, y) => y.total - x.total);
        }, [inputData, displayList]);
    
        return (
            <div className="space-y-6 animate-fade-in text-white">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center bg-slate-800 p-4 rounded-xl border border-slate-700 gap-4">
                    <div className="flex items-center gap-4">
                        <h2 className="text-2xl font-bold text-yellow-500 flex gap-2"><Icon name="trophy"/> THI ĐUA TUẦN</h2>
                        <div className="flex items-center gap-2 bg-slate-900 px-3 py-1 rounded border border-slate-600">
                            <span className="text-slate-400 text-xs uppercase font-bold">Tuần</span>
                            <input type="number" min="1" max="35" value={week} onChange={(e) => setWeek(e.target.value)} className="bg-transparent w-8 text-center font-bold outline-none text-yellow-400"/>
                        </div>
                    </div>
                    
                    {/* MỚI: Component chọn khối */}
                    {!isEditing && <div className="self-center"><GradeTabs current={filterGrade} onChange={setFilterGrade} /></div>}
{!isEditing ? 
                        <button onClick={() => setIsEditing(true)} className="bg-blue-600 hover:bg-blue-500 px-4 py-2 rounded font-bold flex gap-2 ml-auto md:ml-0"><Icon name="edit-3" size={18}/> Nhập điểm</button> : 
                        <div className="flex gap-2 ml-auto md:ml-0">
                            <button onClick={() => setIsEditing(false)} className="bg-slate-600 hover:bg-slate-500 px-4 py-2 rounded">Hủy</button>
                            <button onClick={saveAllScores} disabled={isLoading} className="bg-green-600 hover:bg-green-500 px-4 py-2 rounded font-bold flex gap-2">{isLoading ? <Icon name="loader" className="animate-spin"/> : 'Lưu lại'}</button>
                        </div>
                    }
                </div>
    
                {!isEditing ? (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        {sortedRanking.length === 0 ? <div className="col-span-full text-center p-10 italic text-slate-500 border border-dashed border-slate-700 rounded-xl">Chưa có dữ liệu tuần {week} {filterGrade ? `cho Khối ${filterGrade}` : ''}. Hãy bấm "Nhập điểm".</div> :
                        sortedRanking.map((item, index) => (
                            <div key={item.classId} className={`p-4 rounded-xl border relative overflow-hidden shadow-lg ${index<3 ? 'border-yellow-500/50 bg-gradient-to-br from-yellow-900/20 to-slate-900' : 'border-slate-700 bg-slate-800'}`}>
                                <div className="flex justify-between items-center relative z-10">
                                    <div className="flex items-center gap-3">
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold ${index===0?'bg-yellow-500 text-black':index===1?'bg-slate-300 text-black':index===2?'bg-orange-600': 'bg-slate-700 text-slate-400'}`}>{index+1}</div>
                                        <span className="text-2xl font-bold">{item.classId}</span>
                                    </div>
                                    <div className="text-right">
                                        <div className="text-3xl font-black text-yellow-400">{item.total}</div>
                                        <div className="text-[10px] text-slate-400">TỔNG ĐIỂM</div>
                                    </div>
                                </div>
                                <div className="mt-4 grid grid-cols-4 gap-1 text-center text-xs text-slate-400 bg-slate-900/50 p-2 rounded">
                                    <div><div className="font-bold text-white">{item.a}</div>SĐB(3)</div>
<div><div className="font-bold text-white">{item.b}</div>NN(2)</div>
                                    <div><div className="font-bold text-white">{item.c}</div>CC(1)</div>
                                    <div><div className="font-bold text-green-400">{item.d}</div>PT</div>
                                </div>
                            </div>
                        ))}
                    </div>
                ) : (
                    <div className="bg-slate-900 rounded-xl border border-slate-700 overflow-x-auto">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-800 text-slate-400 uppercase text-xs font-bold">
                                <tr>
                                    <th className="p-3">Lớp</th>
                                    <th className="p-3 w-24">SĐB (x3)</th>
                                    <th className="p-3 w-24">Nề nếp (x2)</th>
                                    <th className="p-3 w-24">Chào cờ (x1)</th>
                                    <th className="p-3 w-24">P.Trào</th>
                                    <th className="p-3 text-right">Tổng (T)</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {displayList.map(cls => {
                                    const d = inputData[cls] || {};
                                    return (
                                        <tr key={cls} className="hover:bg-slate-800/50">
                                            <td className="p-3 font-bold text-blue-400">{cls}</td>
                                            <td className="p-2"><input type="number" step="0.1" className="w-full bg-slate-800 border border-slate-600 rounded p-1 text-center focus:border-blue-500 outline-none" value={d.a} onChange={e=>handleInputChange(cls,'a',e.target.value)} placeholder="..."/></td>
                                            <td className="p-2"><input type="number" className="w-full bg-slate-800 border border-slate-600 rounded p-1 text-center focus:border-blue-500 outline-none" value={d.b} onChange={e=>handleInputChange(cls,'b',e.target.value)} placeholder="100"/></td>
                                            <td className="p-2"><input type="number" className="w-full bg-slate-800 border border-slate-600 rounded p-1 text-center focus:border-blue-500 outline-none" value={d.c} onChange={e=>handleInputChange(cls,'c',e.target.value)} placeholder="100"/></td>
<td className="p-2"><input type="number" className="w-full bg-slate-800 border border-slate-600 rounded p-1 text-center focus:border-blue-500 outline-none" value={d.d} onChange={e=>handleInputChange(cls,'d',e.target.value)} placeholder="0"/></td>
                                            <td className="p-3 text-right font-bold text-green-400 font-mono text-lg">{calculateTotal(d.a,d.b,d.c,d.d)}</td>
                                        </tr>
                                    )
                                })}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        );
    };
   
    function App() {
      // Load theme from local storage
      const [currentTheme, setCurrentTheme] = useState(() => {
        const saved = localStorage.getItem('THPT_THEME');
        return saved ? JSON.parse(saved) : THEMES[0];
      });
      
      const [view, setView] = useState(() => localStorage.getItem('THPT_APP_USER') ? 'dashboard' : 'home'); 
      const [appUser, setAppUser] = useState(() => {
        const savedUser = localStorage.getItem('THPT_APP_USER');
        return savedUser ? JSON.parse(savedUser) : null;
      });
      
      const [notification, setNotification] = useState({ message: '', type: '' });
      const [usersList, setUsersList] = useState([]);
      const [studentsList, setStudentsList] = useState([]);
      const [violationsList, setViolationsList] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [isRefreshing, setIsRefreshing] = useState(false);
      
      const [loginForm, setLoginForm] = useState({ username: '', password: '' });
      const [registerForm, setRegisterForm] = useState({ firstName: '', lastName: '', username: '', role: 'prefect', email: '', password: '', confirmPassword: '' });
      
      const showToast = (msg, type='success') => setNotification({ message: msg, type });
      const isFetchingRef = useRef(false);
      
      useEffect(() => { 
        let interval;
        if (appUser) {
          refreshData(false); 
          interval = setInterval(() => { refreshData(true); }, 5000); 
        }
        return () => { if (interval) clearInterval(interval); };
      }, [appUser]);
      
      useEffect(() => { if (window.lucide) window.lucide.createIcons(); });
      
      // Save theme to local storage on change
      const handleSetTheme = (theme) => {
        setCurrentTheme(theme);
        localStorage.setItem('THPT_THEME', JSON.stringify(theme));
      };
      
      
      const refreshData = async (isBackground = false) => {
        if (isFetchingRef.current) return;
        isFetchingRef.current = true;
if (!isBackground) setIsRefreshing(true);
        try {
          const [users, students, violations] = await Promise.all([
            api.fetchData('users'), api.fetchData('students'), api.fetchData('violations')
          ]);
          if (users.length > 0) setUsersList(prev => JSON.stringify(prev) !== JSON.stringify(users) ? users : prev);
          if (students.length > 0) setStudentsList(prev => JSON.stringify(prev) !== JSON.stringify(students) ? students : prev);
          if (violations.length > 0) setViolationsList(prev => JSON.stringify(prev) !== JSON.stringify(violations) ? violations : prev);
        } catch (error) { console.error("Lỗi cập nhật dữ liệu:", error); } 
        finally {
          if (!isBackground) setIsRefreshing(false);
          isFetchingRef.current = false;
        }
      };
      
      // NEW: Hàm xóa vi phạm khỏi state ngay lập tức (Optimistic Update)
      const handleLocalDelete = (id) => {
        setViolationsList(prev => prev.filter(v => v.id !== id));
      };
      
      const handleLogin = () => {
        const { username, password } = loginForm;
        if (!username || !password) return showToast('Vui lòng nhập đủ thông tin', 'error');
        if (username === 'THPTNGUYENTRAI' && password === 'NGUYENTRAIDANANG') {
          const adminUser = { id: 'admin', fullName: 'Quản Trị Viên', role: 'admin' };
          setAppUser(adminUser);
          localStorage.setItem('THPT_APP_USER', JSON.stringify(adminUser));
          setView('dashboard'); return;
        }
        setIsLoading(true);
        api.fetchData('users').then(users => {
          setIsLoading(false);
          if (!Array.isArray(users) || users.length === 0) { showToast('Lỗi kết nối CSDL hoặc sai thông tin', 'error'); return; }
          const found = users.find(u => u.username == username && u.password == password);
          if (found) {
            if (found.status === 'pending') { showToast('Tài khoản đang chờ phê duyệt!', 'error'); } 
            else { 
              const userWithFullName = { ...found, fullName: getFullName(found) };
              setAppUser(userWithFullName); 
              localStorage.setItem('THPT_APP_USER', JSON.stringify(userWithFullName));
              setView('dashboard'); 
            }
          } else { showToast('Sai tên đăng nhập hoặc mật khẩu', 'error'); }
        });
      };
      
      const handleLogout = () => {
        setAppUser(null);
        localStorage.removeItem('THPT_APP_USER');
        setView('home');
      };
      
      const handleRegister = async () => {
        if (registerForm.password !== registerForm.confirmPassword) return showToast('Mật khẩu không khớp', 'error');
if (!registerForm.firstName || !registerForm.lastName || !registerForm.email || !registerForm.username) return showToast('Nhập thiếu thông tin', 'error');
        const newUser = { ...registerForm, username: registerForm.username.trim(), status: 'pending', classId: '' };
        setIsLoading(true);
        await api.postData('register', newUser);
        setIsLoading(false);
        showToast('Đăng ký thành công! Chờ duyệt.');
        setView('login');
      };
      
      const HERO_IMAGES = [
        { title: 'Toàn cảnh nhà trường', url: 'https://tracuudiemvnedu.vip/wp-content/uploads/2025/04/thong-rin-ve-truong-thpt-nguyen-trai-da-nang.jpg' },
        { title: 'Cổng trường Nguyễn Trãi', url: 'https://iwater.vn/Image/Picture/New/truong-thpt-nguyen-trai-da-nang.jpg' },
        { title: 'Hoạt động ngoại khóa', url: 'https://r73troypb4obj.vcdn.cloud/website02/uploads/pictures…-gia-truong-thpt-nguyen-trai-tinh-da-nang-co-tot-khong2.jpg' }
      ];
      
      if (view === 'home') {
        return (
          <div className={`min-h-screen text-white flex flex-col font-sans transition-colors duration-500 ${currentTheme.class}`}>
            <header className="bg-slate-900/80 backdrop-blur-md border-b border-slate-700 shadow-lg sticky top-0 z-50">
              <div className="container mx-auto px-4 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                <div className="flex items-center gap-3 flex-1">
                  <SchoolLogo size="md" />
                  <div><h2 className="text-red-500 font-bold text-sm uppercase drop-shadow-md">Sở Giáo Dục Đào Tạo Thành Phố Đà Nẵng</h2><h1 className="text-white font-bold text-xl uppercase mt-1 drop-shadow-lg">Trường THPT Nguyễn Trãi</h1></div>
                </div>
                <div className="flex items-center gap-4">
                  <div className="flex items-center gap-2 text-white font-bold text-lg"><Icon name="phone" size={20}/> 02363842322</div>
                  <div className="flex gap-3 items-center">
                    <ThemeSelector currentTheme={currentTheme} onSelectTheme={handleSetTheme} />
                    {appUser ? (<button onClick={() => setView('dashboard')} className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-full font-bold border border-blue-400 flex items-center gap-2"><Icon name="layout-dashboard" size={18}/> Vào Hệ Thống</button>) : (<><button onClick={() => setView('login')} className="bg-[#c2410c] hover:bg-[#9a3412] text-white px-6 py-2 rounded-full font-bold border border-orange-400">Đăng nhập</button><button onClick={() => setView('register')} className="bg-[#ea580c] hover:bg-[#c2410c] text-white px-6 py-2 rounded-full font-bold border border-orange-400">Đăng kí</button></>)}
</div>
                </div>
              </div>
            </header>
            <div className="bg-white/10 py-2 text-center text-white font-medium border-b-4 border-blue-500 shadow-md z-10 backdrop-blur-sm">01 Phan Văn Định, Phường Liên Chiểu, TP Đà Nẵng</div>
            <div className="flex-1 p-8 flex items-center justify-center relative">
              <div className="absolute inset-0 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')] opacity-10 pointer-events-none"></div>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6 w-full max-w-6xl z-10">
                {HERO_IMAGES.map((item, i) => (
                  <div key={i} className="rounded-2xl overflow-hidden border-4 border-white/20 shadow-2xl h-64 md:h-96 relative group cursor-pointer hover:border-white/50 transition-all">
                    <img src={item.url} alt={item.title} className="w-full h-full object-cover transform group-hover:scale-110 transition-transform duration-700" />
                    <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-transparent flex items-end p-6"><span className="font-bold text-xl text-white drop-shadow-md border-l-4 border-red-500 pl-3">{item.title}</span></div>
                  </div>
                ))}
              </div>
            </div>
            {notification.message && <Toast {...notification} onClose={() => setNotification({})} />}
          </div>
        );
      }
      
      if (view === 'login' || view === 'register') {
        const isLogin = view === 'login';
        return (
          <div className={`min-h-screen flex items-center justify-center p-4 relative bg-[url('https://www.transparenttextures.com/patterns/stardust.png')] transition-colors duration-500 ${currentTheme.class}`}>
            {isLoading && <div className="absolute inset-0 bg-black/70 z-50 flex items-center justify-center text-white flex-col gap-4"><div className="w-10 h-10 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>Đang xử lý...</div>}
            
            <div className="absolute top-6 right-6 z-50">
              <ThemeSelector currentTheme={currentTheme} onSelectTheme={handleSetTheme} />
            </div>
            
            <div className="bg-slate-800/90 backdrop-blur-md w-full max-w-md p-8 rounded-2xl shadow-2xl border border-slate-700 relative overflow-hidden">
              <div className={`absolute top-0 left-0 w-full h-2 bg-gradient-to-r ${isLogin?'from-blue-500 to-purple-500':'from-orange-500 to-red-500'}`}></div>
              <div className="flex justify-center mb-6">
                <SchoolLogo size="lg" className="border-4 border-red-600" />
              </div>
<h2 className="text-3xl font-bold text-white text-center mb-6 uppercase tracking-wider">{isLogin?'Đăng nhập':'Đăng kí tài khoản'}</h2>
              <div className="space-y-5">
                {!isLogin && (<div className="flex gap-3"><input placeholder="Họ" className="w-1/2 bg-slate-900 border border-slate-600 p-3 rounded-lg outline-none focus:border-blue-500" value={registerForm.firstName} onChange={e=>setRegisterForm({...registerForm, firstName: e.target.value})}/><input placeholder="Tên" className="w-1/2 bg-slate-900 border border-slate-600 p-3 rounded-lg outline-none focus:border-blue-500" value={registerForm.lastName} onChange={e=>setRegisterForm({...registerForm, lastName: e.target.value})}/></div>)}
                {!isLogin && <select className="w-full bg-slate-900 border border-slate-600 p-3 rounded-lg outline-none focus:border-blue-500" value={registerForm.role} onChange={e=>setRegisterForm({...registerForm, role: e.target.value})}><option value="prefect">Ban Thi Đua</option><option value="teacher">Giáo viên chủ nhiệm</option></select>}
                {!isLogin && <input placeholder="Email (Gmail)" className="w-full bg-slate-900 border border-slate-600 p-3 rounded-lg outline-none focus:border-blue-500" value={registerForm.email} onChange={e=>setRegisterForm({...registerForm, email: e.target.value})}/>}
                <div className="flex items-center bg-slate-900 rounded-xl border border-slate-600 px-4 py-3 focus-within:border-blue-500 transition-all"><Icon name="user" size={20} className="text-slate-500 mr-3"/><input value={isLogin ? loginForm.username : registerForm.username} onChange={e => isLogin ? setLoginForm({...loginForm, username: e.target.value}) : setRegisterForm({...registerForm, username: e.target.value})} type="text" className="bg-transparent flex-1 text-white outline-none" placeholder={isLogin ? "Tên đăng nhập" : "Tên đăng nhập tự tạo"} /></div>
                <PasswordField value={isLogin ? loginForm.password : registerForm.password} onChange={e => isLogin ? setLoginForm({...loginForm, password: e.target.value}) : setRegisterForm({...registerForm, password: e.target.value})} placeholder="Mật khẩu" />
                {!isLogin && (<PasswordField value={registerForm.confirmPassword} onChange={e => setRegisterForm({...registerForm, confirmPassword: e.target.value})} placeholder="Nhập lại mật khẩu" />)}
                <button onClick={isLogin?handleLogin:handleRegister} className={`w-full bg-gradient-to-r ${isLogin?'from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600':'from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500'} text-white font-bold py-3.5 rounded-xl mt-4 shadow-lg active:scale-95 transition-all`}>{isLogin?'ĐĂNG NHẬP':'ĐĂNG KÍ NGAY'}</button>
<div className="flex justify-between mt-4 text-sm font-medium"><button onClick={()=>setView('home')} className="text-blue-400 hover:text-blue-300 flex items-center gap-1 transition-colors"><Icon name="home" size={14}/> Trang chủ</button><button onClick={()=>setView(isLogin?'register':'login')} className="text-blue-400 hover:text-blue-300 transition-colors">{isLogin?'Chưa có tài khoản?':'Đã có tài khoản?'}</button></div>
              </div>
            </div>
            {notification.message && <Toast {...notification} onClose={() => setNotification({})} />}
          </div>
        );
      }
      
      if (view === 'dashboard') {
        return (
          <div className={`min-h-screen text-white font-sans transition-colors duration-500 ${currentTheme.class}`}>
            <header className="bg-slate-900/90 backdrop-blur-md p-4 flex justify-between items-center shadow-lg sticky top-0 z-40 border-b border-white/10">
              <div className="flex items-center gap-3 cursor-pointer hover:opacity-90" onClick={()=>setView('dashboard')}>
                <SchoolLogo size="md" />
                <div className="hidden sm:block"><div className="text-[10px] text-blue-200 uppercase tracking-widest">Hệ thống quản lý</div><span className="font-bold text-lg leading-none">THPT NGUYỄN TRÃI</span></div></div>
              <div className="flex items-center gap-4">
                <div className="hidden md:flex flex-col items-end"><span className="text-sm font-bold">{getFullName(appUser)}</span><span className="text-xs text-blue-300 bg-blue-900 px-2 py-0.5 rounded-full">{getRoleDisplayName(appUser?.role)}</span></div>
                <ThemeSelector currentTheme={currentTheme} onSelectTheme={handleSetTheme} />
                <button onClick={() => refreshData(false)} disabled={isRefreshing} className={`p-2 bg-blue-700 hover:bg-blue-600 rounded-lg transition-all shadow-md text-white border border-blue-500 ${isRefreshing ? 'opacity-80 cursor-wait' : ''}`} title="Làm mới dữ liệu ngay lập tức"><Icon name="refresh-cw" size={20} className={isRefreshing ? "animate-spin" : ""}/></button>
                <button onClick={handleLogout} className="p-2 bg-red-600 hover:bg-red-500 rounded-lg transition-all shadow-md text-white" title="Đăng xuất"><Icon name="log-out" size={20}/></button>
              </div>
            </header>
            <div className="container mx-auto p-4 md:p-6">
              <div className="animate-fade-in">
                <div className="flex items-center gap-3 mb-8"><div className="w-1.5 h-8 bg-red-500 rounded-full"></div><h2 className="text-2xl font-bold uppercase tracking-wide">Tiện ích hệ thống</h2></div>
                
<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {/* 1. NÚT BÁO CÁO VI PHẠM */}
                    <div onClick={()=>setView('report')} className="bg-slate-800 hover:bg-slate-700 p-8 rounded-2xl border border-slate-600 cursor-pointer transition-all hover:-translate-y-1 hover:shadow-2xl hover:border-blue-500 group flex flex-col items-center justify-center gap-4 text-center relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-br from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="w-20 h-20 rounded-full bg-blue-900/30 flex items-center justify-center group-hover:scale-110 border border-blue-500/30">
                            <Icon name="file-text" size={40} className="text-blue-400"/>
                        </div>
                        <span className="text-xl font-bold group-hover:text-blue-400 transition-colors">Báo Cáo Vi Phạm</span>
                        <p className="text-slate-400 text-sm">Ghi nhận vi phạm và tự động gửi thông báo.</p>
                    </div>
                
                    {/* 2. NÚT BẢNG XẾP HẠNG */}
                    <div onClick={()=>setView('ranking')} className="bg-slate-800 hover:bg-slate-700 p-8 rounded-2xl border border-slate-600 cursor-pointer transition-all hover:-translate-y-1 hover:shadow-2xl hover:border-yellow-500 group flex flex-col items-center justify-center gap-4 text-center relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-br from-yellow-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="w-20 h-20 rounded-full bg-yellow-900/30 flex items-center justify-center group-hover:scale-110 border border-yellow-500/30">
                            <Icon name="trophy" size={40} className="text-yellow-400"/>
                        </div>
                        <span className="text-xl font-bold group-hover:text-yellow-400 transition-colors">Bảng Xếp Hạng</span>
                        <p className="text-slate-400 text-sm">Tính điểm thi đua & Xếp hạng tuần.</p>
                    </div>
                
                    {/* 3. NÚT TRA CỨU & THỐNG KÊ */}
                    <div onClick={()=>setView('stats')} className="bg-slate-800 hover:bg-slate-700 p-8 rounded-2xl border border-slate-600 cursor-pointer transition-all hover:-translate-y-1 hover:shadow-2xl hover:border-green-500 group flex flex-col items-center justify-center gap-4 text-center relative overflow-hidden">
<div className="absolute inset-0 bg-gradient-to-br from-green-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="w-20 h-20 rounded-full bg-green-900/30 flex items-center justify-center group-hover:scale-110 border border-green-500/30">
                            <Icon name="bar-chart-2" size={40} className="text-green-400"/>
                        </div>
                        <span className="text-xl font-bold group-hover:text-green-400 transition-colors">Tra Cứu & Thống Kê</span>
                        <p className="text-slate-400 text-sm">Xem biểu đồ và lịch sử vi phạm.</p>
                    </div>
                
                    {/* 4. NÚT QUẢN LÝ DỮ LIỆU */}
                    <div onClick={()=>setView('manage')} className="bg-slate-800 hover:bg-slate-700 p-8 rounded-2xl border border-slate-600 cursor-pointer transition-all hover:-translate-y-1 hover:shadow-2xl hover:border-purple-500 group flex flex-col items-center justify-center gap-4 text-center relative overflow-hidden">
                        <div className="absolute inset-0 bg-gradient-to-br from-purple-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="w-20 h-20 rounded-full bg-purple-900/30 flex items-center justify-center group-hover:scale-110 border border-purple-500/30">
                            <Icon name="users" size={40} className="text-purple-400"/>
                        </div>
                        <span className="text-xl font-bold group-hover:text-purple-400 transition-colors">Quản Lý Dữ Liệu</span>
                        <p className="text-slate-400 text-sm">Quản lý danh sách GV và HS.</p>
                    </div>
                
                    {/* 5. NÚT PHÊ DUYỆT (CHỈ ADMIN) */}
                    {appUser.role === 'admin' && (
                    <div onClick={()=>setView('approve')} className="bg-slate-800 hover:bg-slate-700 p-8 rounded-2xl border border-slate-600 cursor-pointer transition-all hover:-translate-y-1 hover:shadow-2xl hover:border-orange-500 group flex flex-col items-center justify-center gap-4 text-center relative overflow-hidden md:col-span-2 lg:col-span-2">
                        <div className="absolute inset-0 bg-gradient-to-br from-orange-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div className="relative">
                            <div className="w-20 h-20 rounded-full bg-orange-900/30 flex items-center justify-center group-hover:scale-110 border border-orange-500/30">
                                <Icon name="check-circle" size={40} className="text-orange-400"/>
</div>
                            {usersList.some(u=>u.status==='pending') && <span className="absolute top-0 right-0 w-6 h-6 bg-red-600 rounded-full flex items-center justify-center text-xs font-bold animate-bounce border-2 border-slate-800">!</span>}
                        </div>
                        <span className="text-xl font-bold group-hover:text-orange-400 transition-colors">Phê Duyệt Tài Khoản</span>
                        <p className="text-slate-400 text-sm">Duyệt quyền truy cập cho giáo viên và sao đỏ.</p>
                    </div>
                    )}
                </div>
              </div>
            </div>
            {notification.message && <Toast {...notification} onClose={() => setNotification({})} />}
            {isLoading && <div className="fixed inset-0 bg-black/80 z-[60] flex items-center justify-center flex-col gap-4 text-white font-bold backdrop-blur-sm"><div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div><span>Đang đồng bộ dữ liệu...</span></div>}
          </div>
        );
      }
      
      if (view === 'approve') return <div className={`min-h-screen p-6 transition-colors duration-500 ${currentTheme.class} text-white`}><button onClick={()=>setView('dashboard')} className="mb-4 flex items-center gap-2 text-slate-300 hover:text-white font-bold"><Icon name="arrow-left"/> Quay lại</button><ApproveComponent usersList={usersList} setUsersList={setUsersList} showToast={showToast} refreshData={refreshData} /></div>;
      if (view === 'manage') return <div className={`min-h-screen p-6 transition-colors duration-500 ${currentTheme.class} text-white`}><button onClick={()=>setView('dashboard')} className="mb-4 flex items-center gap-2 text-slate-300 hover:text-white font-bold"><Icon name="arrow-left"/> Quay lại</button><ManageComponent usersList={usersList} showToast={showToast} refreshData={refreshData} /></div>;
      if (view === 'report') return <div className={`min-h-screen p-6 transition-colors duration-500 ${currentTheme.class} text-white`}><button onClick={()=>setView('dashboard')} className="mb-4 flex items-center gap-2 text-slate-300 hover:text-white font-bold"><Icon name="arrow-left"/> Quay lại</button><ReportComponent studentsList={studentsList} appUser={appUser} showToast={showToast} /></div>;
      if (view === 'stats') return <div className={`min-h-screen p-6 transition-colors duration-500 ${currentTheme.class} text-white`}><button onClick={()=>setView('dashboard')} className="mb-4 flex items-center gap-2 text-slate-300 hover:text-white font-bold"><Icon name="arrow-left"/> Quay lại</button><StatsComponent violationsList={violationsList} showToast={showToast} appUser={appUser} refreshData={refreshData} onDeleteLocal={handleLocalDelete} /></div>;
if (view === 'ranking') return <div className={`min-h-screen p-6 ${currentTheme.class} text-white`}><button onClick={()=>setView('dashboard')} className="mb-4 flex gap-2 font-bold hover:text-blue-400"><Icon name="arrow-left"/> Quay lại</button><RankingComponent showToast={showToast} api={api} CLASS_LIST={CLASS_LIST} /></div>;
     
      return null;
    }
    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
